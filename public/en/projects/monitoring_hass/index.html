<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>A DIY solution for monitoring consumption with Home Assistant | Redwan</title>
<meta name="keywords" content="">
<meta name="description" content="A solution for monitoring electricity and water consumption, integrated into the Home Assistant home automation environment">
<meta name="author" content="Alexandre Pichot">
<link rel="canonical" href="http://localhost:1313/en/projects/monitoring_hass/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.9f20f4d06b66d242482365943742c14b9a72e5be26f427cc1511376c6804e433.css" integrity="sha256-nyD00Gtm0kJII2WUN0LBS5py5b4m9CfMFRE3bGgE5DM=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/en/projects/monitoring_hass/">
<link rel="alternate" hreflang="fr" href="http://localhost:1313/fr/projects/monitoring_hass/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
</head>

<body class="" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/en/" accesskey="h" title="Redwan (Alt + H)">Redwan</a>
            <div class="logo-switches">
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="http://localhost:1313/fr/" title="üá´üá∑"
                            aria-label="üá´üá∑">üá´üá∑</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/en/" title="üè† Home">
                    <span>üè† Home</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/en/about/" title="üôÇ About">
                    <span>üôÇ About</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/en/projects/" title="üîß Projects">
                    <span>üîß Projects</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/en/">Home</a>&nbsp;¬ª&nbsp;<a href="http://localhost:1313/en/projects/">üîß Projects</a></div>
    <h1 class="post-title entry-hint-parent">
      A DIY solution for monitoring consumption with Home Assistant
    </h1>
    <div class="post-meta"><span title='2024-07-22 00:00:00 +0000 UTC'>July 22, 2024</span>&nbsp;¬∑&nbsp;8 min&nbsp;¬∑&nbsp;Alexandre Pichot&nbsp;|&nbsp;Translations:
<ul class="i18n_list">
    <li>
        <a href="http://localhost:1313/fr/projects/monitoring_hass/">üá´üá∑</a>
    </li>
</ul>

</div>
  </header> 
<figure class="entry-cover">
        <img loading="eager" src="http://localhost:1313/en/projects/monitoring_hass/image-7.png" alt="">
        
</figure><aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#home-assistant-a-must-have-for-home-automation" aria-label="Home Assistant, a must-have for home automation?">Home Assistant, a must-have for home automation?</a></li>
                    <li>
                        <a href="#monitoring-power-consumption" aria-label="Monitoring power consumption">Monitoring power consumption</a><ul>
                            
                    <li>
                        <a href="#zigbee-meter-installation" aria-label="Zigbee meter installation">Zigbee meter installation</a></li>
                    <li>
                        <a href="#home-assistant-configuration" aria-label="Home Assistant configuration">Home Assistant configuration</a></li></ul>
                    </li>
                    <li>
                        <a href="#monitoring-water-consumption" aria-label="Monitoring water consumption">Monitoring water consumption</a><ul>
                            
                    <li>
                        <a href="#how-do-i-do-it" aria-label="How do I do it?">How do I do it?</a></li>
                    <li>
                        <a href="#a-very-strange-wi-fi-network" aria-label="A very strange WI-FI network&hellip;">A very strange WI-FI network&hellip;</a></li>
                    <li>
                        <a href="#home-assistant-configuration-1" aria-label="Home Assistant configuration">Home Assistant configuration</a></li></ul>
                    </li>
                    <li>
                        <a href="#dashboard-monitoring" aria-label="Dashboard monitoring">Dashboard monitoring</a></li>
                    <li>
                        <a href="#whats-next" aria-label="What&rsquo;s next?">What&rsquo;s next?</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>

  <div class="post-content"><h2 id="home-assistant-a-must-have-for-home-automation">Home Assistant, a must-have for home automation?<a hidden class="anchor" aria-hidden="true" href="#home-assistant-a-must-have-for-home-automation">#</a></h2>
<p>Over the past few years, Home Assistant has really established itself among home automation environments. Its efficiency, compatibility and huge community have propelled it ahead of other open source solutions such as Jeedom.</p>
<p>Having tried out Home Assistant a few months ago, I realized that not only was my entire home automation installation compatible, but that new devices could also be integrated. All that remained was to configure a clean, sustainable solution within Home Assistant.</p>
<p>Most users recommend lightweight devices such as the Raspberry Pi from model 3 upwards to run the home automation server. However, in my case, I thought of an even simpler solution: what if I ran it on my internet box?</p>
<p>The Freebox ultra is Free&rsquo;s new box equipped with the Qualcomm IPQ 9574 SoC, i.e. four ARM Cortex-A73 cores clocked at 2.2GHz, which places it between the Raspberry Pi 4 and 5 in terms of performance. It supports VMs (virtual machines) and USB peripherals, which is very useful for Zigbee devices. All I have to do is plug in a Zigbee key and launch the VM to control all my devices: air conditioners, sensors, lighting&hellip;</p>
<p><img loading="lazy" src="image.png" alt="The Freebox VM window"  />

<em>The Freebox VM window.</em></p>
<h2 id="monitoring-power-consumption">Monitoring power consumption<a hidden class="anchor" aria-hidden="true" href="#monitoring-power-consumption">#</a></h2>
<h3 id="zigbee-meter-installation">Zigbee meter installation<a hidden class="anchor" aria-hidden="true" href="#zigbee-meter-installation">#</a></h3>
<p>One of Home Assistant&rsquo;s major assets is its ability to manage energy consumption and solar installations. With just a few data, it&rsquo;s possible to set up an entire monitoring dashboard (see <a href="https://www.home-assistant.io/home-energy-management/">https://www.home-assistant.io/home-energy-management/</a> ). Initially, I&rsquo;d like to focus on electricity consumption. For this, I have three solutions:</p>
<ul>
<li>Use of the Linky meter (communicating meter from distributor Enedis) via the Enedis API (Cloud, see <a href="https://github.com/bokub/ha-linky">https://github.com/bokub/ha-linky</a> )</li>
<li>Use of the local Linky meter via a TIC module</li>
<li>Installation of an additional Zigbee meter</li>
</ul>
<p>I opted for the last solution, as it seemed the cheapest, but also allowed me to compare the data with that of the Linky cloud. A simple Zigbee device obtainable on AliExpress for around twenty euros would be more than enough.</p>
<p><a href="/en/projects/monitoring_hass/image-1.png">Price of sensor on AliExpress</a>
<em>At that price, I don&rsquo;t expect much&hellip; But I&rsquo;ll be pleasantly surprised!</em></p>
<p>This one is rated for 80 A maximum, which is more than enough. It has two transformers (current collectors) for two channels, which will enable me to differentiate my two electrical panels. Installation is straightforward: just connect it to the mains and loop the two current sensors (see photo below):</p>
<p><a href="/en/projects/monitoring_hass/image-22.png">Electrical assembly</a>
<em>Red on red and blue on blue.</em></p>
<p>The sensor lights up with both probes properly installed. All I need to do now is configure it.</p>
<h3 id="home-assistant-configuration">Home Assistant configuration<a hidden class="anchor" aria-hidden="true" href="#home-assistant-configuration">#</a></h3>
<p>First of all, the device isn&rsquo;t fully plug and play; the data is present but raw and unformatted. Fortunately, the Home Assistant community is large enough to have produced a ZHA quirk, which is simply a formatting file for Zigbee Home Assistant (see <a href="https://forum.hacf.fr/t/zigbee2mqtt-et-probleme-avec-compteur-energie-tuya-zigbee/29847">https://forum.hacf.fr/t/zigbee2mqtt-et-probleme-avec-compteur-energie-tuya-zigbee/29847</a> ). Once the file has been integrated, our consumption data is displayed:</p>
<p><img loading="lazy" src="image-3.png" alt="Sensor data"  />

<em>But what am I gonna do with all this data?</em></p>
<p>All that&rsquo;s left is to use the mathematical integration templates to switch from instantaneous power to consumption in kWh (see <a href="https://www.home-assistant.io/integrations/integration/">https://www.home-assistant.io/integrations/integration/</a> ). This consumption can be directly integrated into the Energy tab of Home Assistant:</p>
<p><img loading="lazy" src="image-4.png" alt="Histogram of energy consumption"  />

<em>This looks great, doesn&rsquo;t it?</em></p>
<p>This data corresponds to the Zigbee sensor, and the decarbonized energy rate is taken directly from the Electricity Maps API (great site to check out here: <a href="https://app.electricitymaps.com/map">https://app.electricitymaps.com/map</a> ).</p>
<p>For fun, I&rsquo;ve also integrated data from the Linky cloud to compare consumption, and the results are quite surprising:</p>
<p><img loading="lazy" src="image-6.png" alt="Excel data table"  />
</p>
<p><img loading="lazy" src="image-5.png" alt="Data Histogram"  />

<em>Obviously, Linky is higher&hellip;</em></p>
<p>Firstly, the Zigbee sensor is very similar to the Linky sensor, despite its low price! Secondly, the differences are almost constant, suggesting that upstream consumption is not taken into account. The Linky meter consumes between 2 and 10W, and is the only upstream device. This discrepancy is either an offset sensor calibration error (constant), or an unidentified device in my electrical installation. The mystery remains unsolved to this day&hellip; (big doubts about this sensor though).</p>
<h2 id="monitoring-water-consumption">Monitoring water consumption<a hidden class="anchor" aria-hidden="true" href="#monitoring-water-consumption">#</a></h2>
<h3 id="how-do-i-do-it">How do I do it?<a hidden class="anchor" aria-hidden="true" href="#how-do-i-do-it">#</a></h3>
<p>Power consumption monitoring is simple and non-intrusive. No wiring had to be modified. Monitoring water consumption is much more complicated. Although there are devices to do this, the piping has to be modified, and my plumbing skills are almost non-existent. The same problem applies to monitoring gas consumption.</p>
<p>Then there are communicating meters like Linky, or GRDF&rsquo;s Gazpar meter, for example. It&rsquo;s either possible to install a mod like the TIC module, or to use the suppliers&rsquo; cloud API directly. However, I&rsquo;ve found an even simpler solution for my situation, and it starts with the discovery of a very strange Wi-Fi network&hellip;</p>
<h3 id="a-very-strange-wi-fi-network">A very strange WI-FI network&hellip;<a hidden class="anchor" aria-hidden="true" href="#a-very-strange-wi-fi-network">#</a></h3>
<p>While wandering around the beaches and Zigbee channels (who doesn&rsquo;t do that?), I noticed a very strange network. It was called BWT@7642 and was particularly close. A Google search tells me that BWT is a manufacturer of water treatment products; I immediately make the connection with my softener. This one is indeed from BWT, but what is a Wi-Fi network doing on this machine?</p>
<p>BWT offers home automation solutions for water softeners, but mine isn&rsquo;t one of them. So what&rsquo;s the point of a Wi-Fi network (and Bluetooth for that matter) on a softener? I log on and come across this page:</p>
<p><a href="/en/projects/monitoring_hass/image-2.png">Water softener home page</a>
<em>Water softener home page</em></p>
<p>I&rsquo;ve got some maintenance information, which will be very useful. Let&rsquo;s see how requests for this information are handled:</p>
<p><a href="/en/projects/monitoring_hass/image-8.png">HTTP requests</a>
<em>Slow down on requests!</em></p>
<p>Every second, a script sends a get request to a link (http://192.168.1.72/cgi-bin/getinfo1) and the device returns a JSON string:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;remRege&#34;</span>:<span style="color:#ae81ff">2000</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;remCapa&#34;</span>:<span style="color:#ae81ff">42</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;remSalt&#34;</span>:<span style="color:#ae81ff">7000</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;waterCons&#34;</span>:<span style="color:#ae81ff">645</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;waterRege&#34;</span>:<span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;alarme&#34;</span>:<span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;etat&#34;</span>:<span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;error&#34;</span>:<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>You&rsquo;ll notice that there&rsquo;s more information than on the page itself, especially on water consumption. Knowing that all water goes through the softener, we&rsquo;ll have direct information on water consumption in the home.</p>
<p>What&rsquo;s more, this data concerns total volume, not actual flow. By way of analogy, with electricity consumption, we used to have instantaneous power rather than energy consumed, but now we have water consumed rather than flow rate. This will make it easier to integrate into Home Assistant&rsquo;s energy tab.</p>
<h3 id="home-assistant-configuration-1">Home Assistant configuration<a hidden class="anchor" aria-hidden="true" href="#home-assistant-configuration-1">#</a></h3>
<p>Knowing that we have a JSON string on an address, all we need is a Home Assistant integration that can make HTTP requests. It exists and is called RESTful, based on the REpresentational State Transfer or REST API, which enables data communication between machines. Here&rsquo;s my YAML configuration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">rest</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">authentication</span>: <span style="color:#ae81ff">basic</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scan_interval</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resource</span>: <span style="color:#ae81ff">http://192.168.1.72/cgi-bin/getinfo1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sensor</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;Remaining Rege&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">json_attributes_path</span>: <span style="color:#e6db74">&#34;$&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">value_template</span>: <span style="color:#e6db74">&#39;{{ value_json.remRege }}&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">unit_of_measurement</span>: <span style="color:#e6db74">&#34;g&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">state_class</span>: <span style="color:#e6db74">&#34;measurement&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">device_class</span>: <span style="color:#e6db74">&#34;weight&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">json_attributes</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#ae81ff">remRege</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;Remaining Capacity&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">json_attributes_path</span>: <span style="color:#e6db74">&#34;$&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">value_template</span>: <span style="color:#e6db74">&#39;{{ value_json.remCapa }}&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">unit_of_measurement</span>: <span style="color:#e6db74">&#34;kg&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">state_class</span>: <span style="color:#e6db74">&#34;measurement&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">device_class</span>: <span style="color:#e6db74">&#34;weight&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">json_attributes</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#ae81ff">remCapa</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;Remaining Salt&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">json_attributes_path</span>: <span style="color:#e6db74">&#34;$&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">value_template</span>: <span style="color:#e6db74">&#39;{{ value_json.remSalt }}&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">unit_of_measurement</span>: <span style="color:#e6db74">&#34;g&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">state_class</span>: <span style="color:#e6db74">&#34;measurement&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">device_class</span>: <span style="color:#e6db74">&#34;weight&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">json_attributes</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#ae81ff">remSalt</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;Water Consumption 2&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">json_attributes_path</span>: <span style="color:#e6db74">&#34;$&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">value_template</span>: <span style="color:#e6db74">&#39;{{ value_json.waterCons }}&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">unit_of_measurement</span>: <span style="color:#e6db74">&#34;L&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">state_class</span>: <span style="color:#e6db74">&#34;total_increasing&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">device_class</span>: <span style="color:#e6db74">&#34;water&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">json_attributes</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#ae81ff">waterCons</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;State&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">json_attributes_path</span>: <span style="color:#e6db74">&#34;$&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">value_template</span>: <span style="color:#e6db74">&#39;{{ value_json.etat }}&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">state_class</span>: <span style="color:#e6db74">&#34;measurement&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">json_attributes</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#ae81ff">etat</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;Error&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">json_attributes_path</span>: <span style="color:#e6db74">&#34;$&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">value_template</span>: <span style="color:#e6db74">&#39;{{ value_json.error }}&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">state_class</span>: <span style="color:#e6db74">&#34;measurement&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">json_attributes</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#ae81ff">error</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;Water Regeneration&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">json_attributes_path</span>: <span style="color:#e6db74">&#34;$&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">value_template</span>: <span style="color:#e6db74">&#39;{{ value_json.waterRege }}&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">state_class</span>: <span style="color:#e6db74">&#34;measurement&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">json_attributes</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#ae81ff">waterRege</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;Alarm&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">json_attributes_path</span>: <span style="color:#e6db74">&#34;$&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">value_template</span>: <span style="color:#e6db74">&#39;{{ value_json.alarme }}&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">state_class</span>: <span style="color:#e6db74">&#34;measurement&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">json_attributes</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#ae81ff">alarme</span>
</span></span></code></pre></div><p>Each time, we assign a sensor to a JSON attribute, specifying the nature of the sensor, its class and unit. This allows the sensor to be directly integrated into the Home Assistant energy tab:</p>
<p><a href="/en/projects/monitoring_hass/image-9.png">Histogram of water consumption</a>
*With the shower, it goes up very quickly!</p>
<p>The other sensors I&rsquo;ve set up will give me information on remaining salt and potential problems with the softener.</p>
<h2 id="dashboard-monitoring">Dashboard monitoring<a hidden class="anchor" aria-hidden="true" href="#dashboard-monitoring">#</a></h2>
<p>Using Home Assistant to control my home automation devices, I already have a dashboard. All I need to do now is integrate the consumption section into it.</p>
<p><a href="/en/projects/monitoring_hass/image-10.png">Home Dashboard</a>
<em>Cool, isn&rsquo;t it?</em></p>
<p>In this dashboard, you&rsquo;ll find the consumption (water and electricity) for the day and the instantaneous consumption. As we saw earlier, it&rsquo;s easy enough to switch between instantaneous and total values, using Home Assistant&rsquo;s mathematical operators for derivation and integration.</p>
<p>For daily consumption, I&rsquo;ll simply reuse the maps from Home Assistant&rsquo;s energy tab (see <a href="https://www.home-assistant.io/dashboards/energy/">https://www.home-assistant.io/dashboards/energy/</a> ). For instantaneous consumption, a custom map will be used (see <a href="https://github.com/flixlix/power-flow-card-plus">https://github.com/flixlix/power-flow-card-plus</a> ). After a few minutes of configuration, I arrive at this result:</p>
<p><img loading="lazy" src="image-11.png" alt="Dashboard monitoring"  />

<em>1.2 kW ?! I think the oven is on.</em></p>
<p>We have instantaneous and even split consumptions for both tables, consumptions per day and histograms per hour.</p>
<h2 id="whats-next">What&rsquo;s next?<a hidden class="anchor" aria-hidden="true" href="#whats-next">#</a></h2>
<p>This consumption monitoring dashboard has enabled us to identify the consumption of appliances, particularly those on standby, and to raise our awareness of the cost of resources. When electricity consumption is a basic 300W, there&rsquo;s real work to be done on the efficiency of appliances that are constantly on, I&rsquo;m thinking in particular of refrigerators and VMCs.</p>
<p>I still have a lot of work to do, especially on integrating the softener and the various alarms. I need to think about implementing it in an interface. I haven&rsquo;t mentioned gas consumption either. Although there&rsquo;s a communicating meter (Gazpar), I&rsquo;ll need to study the subject a bit more to come up with a concrete, sustainable solution.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/en/projects/esp-roomba/">
    <span class="title">¬´ Prev</span>
    <br>
    <span>Connecting an old Roomba robot vacuum to a home automation platform</span>
  </a>
  <a class="next" href="http://localhost:1313/en/projects/ball_and_beam/">
    <span class="title">Next ¬ª</span>
    <br>
    <span>GEII students from the Indre IUT present their ¬´ Ball and Beam ¬ª project at the national EEA Club competition.</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share A DIY solution for monitoring consumption with Home Assistant on x"
            href="https://x.com/intent/tweet/?text=A%20DIY%20solution%20for%20monitoring%20consumption%20with%20Home%20Assistant&amp;url=http%3a%2f%2flocalhost%3a1313%2fen%2fprojects%2fmonitoring_hass%2f&amp;hashtags=">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share A DIY solution for monitoring consumption with Home Assistant on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fen%2fprojects%2fmonitoring_hass%2f&amp;title=A%20DIY%20solution%20for%20monitoring%20consumption%20with%20Home%20Assistant&amp;summary=A%20DIY%20solution%20for%20monitoring%20consumption%20with%20Home%20Assistant&amp;source=http%3a%2f%2flocalhost%3a1313%2fen%2fprojects%2fmonitoring_hass%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share A DIY solution for monitoring consumption with Home Assistant on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fen%2fprojects%2fmonitoring_hass%2f&title=A%20DIY%20solution%20for%20monitoring%20consumption%20with%20Home%20Assistant">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share A DIY solution for monitoring consumption with Home Assistant on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fen%2fprojects%2fmonitoring_hass%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share A DIY solution for monitoring consumption with Home Assistant on whatsapp"
            href="https://api.whatsapp.com/send?text=A%20DIY%20solution%20for%20monitoring%20consumption%20with%20Home%20Assistant%20-%20http%3a%2f%2flocalhost%3a1313%2fen%2fprojects%2fmonitoring_hass%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share A DIY solution for monitoring consumption with Home Assistant on telegram"
            href="https://telegram.me/share/url?text=A%20DIY%20solution%20for%20monitoring%20consumption%20with%20Home%20Assistant&amp;url=http%3a%2f%2flocalhost%3a1313%2fen%2fprojects%2fmonitoring_hass%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share A DIY solution for monitoring consumption with Home Assistant on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=A%20DIY%20solution%20for%20monitoring%20consumption%20with%20Home%20Assistant&u=http%3a%2f%2flocalhost%3a1313%2fen%2fprojects%2fmonitoring_hass%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/en/">Redwan</a></span> ¬∑ 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
</body>

</html>
