<!DOCTYPE html>
<html lang="fr" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Une solution DIY de monitoring des consomation avec Home Assistant | Redwan</title>
<meta name="keywords" content="">
<meta name="description" content="Une solution de monitoring des consomations intégré l&rsquo;environnement domotique Home Assistant">
<meta name="author" content="Redwan Benmansour">
<link rel="canonical" href="//localhost:1313/fr/projects/monitoring_hass/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.af58ab197557f648c5813b484ed1763654423b0bd15690f750a1ab8f8a2ca473.css" integrity="sha256-r1irGXVX9kjFgTtITtF2NlRCOwvRVpD3UKGrj4ospHM=" rel="preload stylesheet" as="style">
<link rel="icon" href="//localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="//localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="//localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="//localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="//localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="fr" href="//localhost:1313/fr/projects/monitoring_hass/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
</head>

<body class="" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="//localhost:1313/fr/" accesskey="h" title="Redwan (Alt + H)">Redwan</a>
            <div class="logo-switches">
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="//localhost:1313/en/" title="English"
                            aria-label="English">En</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="//localhost:1313/fr/" title="Accueil">
                    <span>Accueil</span>
                </a>
            </li>
            <li>
                <a href="//localhost:1313/fr/about/" title="À propos">
                    <span>À propos</span>
                </a>
            </li>
            <li>
                <a href="//localhost:1313/fr/projects/" title="Projets">
                    <span>Projets</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="//localhost:1313/fr/">Accueil</a>&nbsp;»&nbsp;<a href="//localhost:1313/fr/projects/">Projets</a></div>
    <h1 class="post-title entry-hint-parent">
      Une solution DIY de monitoring des consomation avec Home Assistant
    </h1>
    <div class="post-meta">4 min&nbsp;·&nbsp;Redwan Benmansour

</div>
  </header> 
<figure class="entry-cover"><img loading="eager" src="//localhost:1313/fr/projects/image-7.png" alt="">
        
</figure><div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table des matières</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#home-assistant-un-indispensable-de-la-domotique-" aria-label="Home Assistant, un indispensable de la domotique ?">Home Assistant, un indispensable de la domotique ?</a></li>
                <li>
                    <a href="#monitoring-%c3%a9nerg%c3%a9tique" aria-label="Monitoring énergétique">Monitoring énergétique</a><ul>
                        
                <li>
                    <a href="#installation" aria-label="Installation">Installation</a></li>
                <li>
                    <a href="#configuration" aria-label="Configuration">Configuration</a></li></ul>
                </li>
                <li>
                    <a href="#monitoring-de-leau-" aria-label="Monitoring de l&rsquo;eau ?">Monitoring de l&rsquo;eau ?</a></li>
                <li>
                    <a href="#ihm" aria-label="IHM">IHM</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="home-assistant-un-indispensable-de-la-domotique-">Home Assistant, un indispensable de la domotique ?<a hidden class="anchor" aria-hidden="true" href="#home-assistant-un-indispensable-de-la-domotique-">#</a></h2>
<p>Depuis quelques années Home Assistant c&rsquo;est rééllement imposé parmis les environement domotiques. Son efficacité, sa compatibilité et son énorme communauté la propulsé devant d&rsquo;autres solutions open source comme Jeedom.</p>
<p>Ayant essayé Home Assistant il y a quelques mois maintenant, je me suis rendu compte que l&rsquo;intégralité de mon installation domotique été compatible, mais également que de nouveau appareils pouvaient y être intégrés. Il me restait plus qu&rsquo;à configurer une solution propre et durable au sein d&rsquo;Home Assistant.</p>
<p>La plurpart des utilisateurs préconisent les appareils légers tels que la Raspberry Pi à partir du modèle 3 pour faire tourner le serveur domotique. Cepandant dans mon cas, j&rsquo;ai pensé à une solution encore plus simple : et si je le faisait tourner sur ma box internet ?</p>
<p>La freebox ultra est la nouvelle box de free équipée du SoC Qualcomm IPQ 9574, donc 4 coeur ARM Cortex-A73 cadencés à 2.2GHz, ce qui la place entre la Raspberry Pi 4 et 5 en termes de performance. Elle supporte les VM (machines virtuelles) et les périphériques USB, ce qui est très utile pour les appareils zigbee. Il me suffit de brancher une clé Zigbee et de lancer la VM pour piloter tout mes appareils : climatiseurs, capteurs, éclairages&hellip;</p>
<p><img loading="lazy" src="image.png" alt="La fenêtre des VM freebox"  />

<em>La fenêtre des VM freebox</em></p>
<h2 id="monitoring-énergétique">Monitoring énergétique<a hidden class="anchor" aria-hidden="true" href="#monitoring-énergétique">#</a></h2>
<h3 id="installation">Installation<a hidden class="anchor" aria-hidden="true" href="#installation">#</a></h3>
<p>Un atout considérable d&rsquo;Home Assistant est la gestion des consomations énergétiques et des installation solaires. A partir de quelques données, il est possible d&rsquo;établir tout un dashboard de monitoring (voir <a href="https://www.home-assistant.io/home-energy-management/)">https://www.home-assistant.io/home-energy-management/)</a>. Dans un premier temps je souhaite me focaliser sur la consomation électrique. Pour cela j&rsquo;ai trois solutions :</p>
<ul>
<li>Utilisation du compteur Linky par l&rsquo;intérmédiaire de l&rsquo;API Enedis (Cloud, voir <a href="https://github.com/bokub/ha-linky">https://github.com/bokub/ha-linky</a>)</li>
<li>Utilisation du compteur Linky local à l&rsquo;aide d&rsquo;un module TIC</li>
<li>Installation d&rsquo;un compteur Zigbee suplémentaire</li>
</ul>
<p>J&rsquo;ai retenu la dernière solution car elle me paraissait la moins chère mais me permettait également de comparer les données avec celles du cloud Linky. Un simple appareil Zigbee obtenable sur AliExpress pour une vintaine d&rsquo;euros suffirait emplement.</p>
<p><img loading="lazy" src="image-1.png" alt="Prix du capteur sur AliExpress"  />

<em>À ce prix la je n&rsquo;attend pas grand chose&hellip; Mais je vais être agréablement surpris !</em></p>
<p>Celui-ci est calibré pour 80A maximum ce qui est largement suffisant. Il dispose de deux transformateur (capteurs de courant) pour deux canaux ce qui me permettera de différencier mes deux tableaux électriques. Son installation est simple, il suffit de le brancher au réseau et de boucler les deux sondes de courant (voir photo ci-dessous) :</p>
<p><img loading="lazy" src="image-22.png" alt="Montage électrique"  />

<em>Le rouge sur le rouge et le bleu sur le bleu</em></p>
<p>Le capteur s&rsquo;allume avec les deux sondes bien installées. L&rsquo;appareilage se fait simplement et il me suffit maintenant de le configurer.</p>
<h3 id="configuration">Configuration<a hidden class="anchor" aria-hidden="true" href="#configuration">#</a></h3>
<p>Premièrement, l&rsquo;appareil n&rsquo;est pas entièrement plug and play, les données sont présentes mais brutes et non formatées. Heuresement, la communauté Home Assistant est assez grande pour avoir produit un quirk ZHA, qui est simplement un fichier de formattage pour Zigbee Home Assistant (voir <a href="https://forum.hacf.fr/t/zigbee2mqtt-et-probleme-avec-compteur-energie-tuya-zigbee/29847)">https://forum.hacf.fr/t/zigbee2mqtt-et-probleme-avec-compteur-energie-tuya-zigbee/29847)</a>. Une fois le fichier intégré, on retrouve nos données de consomation :</p>
<p><img loading="lazy" src="image-3.png" alt="Données capteur"  />

<em>Mais que vais-je faire de toutes ces données !</em></p>
<p>Il ne reste plus qu&rsquo;à utiliser les templates d&rsquo;intégration mathématique pour passer d&rsquo;une puissance instantanée à une consomation en kWh (voir <a href="https://www.home-assistant.io/integrations/integration/)">https://www.home-assistant.io/integrations/integration/)</a>. Cette consomation peut être directement intégrée à l&rsquo;onglet Énergie d&rsquo;Home Assistant :</p>
<p><img loading="lazy" src="image-4.png" alt="Histogramme de consomation d&amp;rsquo;énergie"  />

<em>C&rsquo;est génial, non ?</em></p>
<p>Ces données correspondes au capteur Zigbee, le taux d&rsquo;énergie décarbonnée est directement récupéré de l&rsquo;API d&rsquo;Electricity Maps (super site à voir ici : <a href="https://app.electricitymaps.com/map)">https://app.electricitymaps.com/map)</a>.</p>
<p>Pour m&rsquo;amuser, j&rsquo;ai également intégré les données du cloud Linky pour comparer les consomations, et les résultats sont assez surprenants :</p>
<p><img loading="lazy" src="image-6.png" alt="Tableau Excel des données"  />
</p>
<p><img loading="lazy" src="image-5.png" alt="Histogramme des données"  />

<em>Forcément c&rsquo;est le Linky qui surestime&hellip;</em></p>
<p>Premièrement, le capteur Zigbee est très proche du capteur Linky malgrès son faible prix ! Par ailleur, les écarts sont quasi constant, ce qui fait penser à une consomation en amont non prise en compte. On serait sur une consomation environ de 25Wh, le compteur Linky à une consommation entre 2 et 10W et serait le seul appareil en amont. Cet écart est alors une erreur de calibrage du capteur en offset (constant), soit un appareil non identifié dans mon installation électrique. Le mystère reste à ce jour non résolu&hellip; (gros doutes sur ce capteur tout de même).</p>
<h2 id="monitoring-de-leau-">Monitoring de l&rsquo;eau ?<a hidden class="anchor" aria-hidden="true" href="#monitoring-de-leau-">#</a></h2>
<h2 id="ihm">IHM<a hidden class="anchor" aria-hidden="true" href="#ihm">#</a></h2>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="//localhost:1313/fr/">Redwan</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
</body>

</html>
